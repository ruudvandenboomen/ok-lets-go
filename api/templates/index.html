<!DOCTYPE html>
<html>

<head>
    <title>OK LET'S GO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static',filename='styles/styles.css') }}">
</head>

<body>
    <div id="modal" class="modal">
        <div class="modal-content">
            <form id="modal-form">
                <h2>Enter your name</h2>
                <input type="text" id="modal-input" placeholder="Name">
                <button id="modal-button" type="submit">OK let's go</button>
            </form>
        </div>
    </div>
    <button id="subscribe-button">Subscribe</button>
    <div class="container">
        <h1>OK LET'S GO</h1>
        <button id="play-button">OK LET'S GO</button>
        <button id="play-button-2">OK LET'S GO DJ</button>
        <button id="play-button-3">OK LET'S GO ROB</button>
        <button id="play-button-4">OK LET'S DIE</button>
    </div>
    <div class="container">
        <div class="chat-header">
            <h1>Chat</h1>
            <p class="chat-online">online: <span id="user-online"></span></p>
        </div>
        <div class="chat">
            <div id="chat-box">
                {% for message in messages %}
                <div class="message">
                    <p class="user">{{ message.sender }}:</p>
                    <p class="content">
                        {{ message.content }}
                    </p>
                </div>
                {% endfor %}
            </div>
        </div>
        <form id="chat-form">
            <input id="chat-input" type="text" placeholder="Type your message here...">
            <div id="chat-input-error"></div>
        </form>
    </div>
    <script type="text/javascript">
        const subscribeButton = document.getElementById('subscribe-button');
        let messageCount = 0
        let userId;
        if (localStorage.getItem("userId")) {
            userId = localStorage.getItem("userId");
        } else {
            userId = uuid.v4();
            localStorage.setItem("userId", userId);
        }
        // Function to update the tab title with a count
        function updateTabTitle(count) {
            document.title = count > 0 ? `(${count}) New Messages` : "OK LET'S GO";
        }

        // Function to handle visibility change
        function handleVisibilityChange() {
            if (document.visibilityState === "visible") {
                messageCount = 0;
                updateTabTitle(messageCount);
            }
        }

        async function checkSubscribed(user_id) {
            resp = await fetch(`${user_id}/subscribed`, {
                method: 'GET',
            });
            const data = await resp.json()
            return data.subscribed
        }

        async function clickSubscriptionButton(subscribed) {
            try {
                if (subscribed) {
                    await unsubscribe();
                    updateSubscriptionButton(subscribed)
                } else {
                    const subscription = await subscribeToPushNotifications();
                    await subscribe(subscription);
                    console.log('Subscribed to push notifications:', subscription);
                }
                updateSubscriptionButton(!subscribed)
                return !subscribed
            } catch (error) {
                console.error('Error subscribing to push notifications:', error);
            }
        }

        async function subscribeToPushNotifications() {
            // Register a service worker
            const registration = await navigator.serviceWorker.register(window.location.origin + '/static/scripts/service-worker.js');
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: 'BC9hogcJliz2VuRVejSkMCLCnHSOby7yh5HkINw6zdclo1sReT9v0HSJkqquY-LvKaNMbX8MK27itRu42za4emg',
            });
            return subscription
        }

        async function subscribe(subscription) {
            // Send the subscription to the backend
            await fetch(`${userId}/subscribe`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(subscription)
            });
        }

        async function unsubscribe() {
            // Send the subscription to the backend
            await fetch(`${userId}/unsubscribe`, {
                method: 'PUT',
            });
        }

        function updateSubscriptionButton(subscribed) {
            if (subscribed) {
                subscribeButton.textContent = "Unsubscribe";
            } else {
                subscribeButton.textContent = "Subscribe";
            }
            subscribeButton.style.display = "block";
        }

        document.addEventListener('DOMContentLoaded', function () {
            var socket = io.connect(window.location.origin, { query: "name=test" });
            var audio = new Audio(window.location.origin + '/static/OK_LETS_GO.mp3');
            var audio2 = new Audio(window.location.origin + '/static/okay_lets_go_dj.mp3');
            var audio3 = new Audio(window.location.origin + '/static/okay_lets_go_rob.mp3');
            var audio4 = new Audio(window.location.origin + '/static/okay_lets_die.mp3');

            // Button click event handler
            document.getElementById('play-button').addEventListener('click', function () {
                socket.emit('play_audio');
            });
            document.getElementById('play-button-2').addEventListener('click', function () {
                socket.emit('play_audio_2');
            });
            document.getElementById('play-button-3').addEventListener('click', function () {
                socket.emit('play_audio_3');
            });
            document.getElementById('play-button-4').addEventListener('click', function () {
                socket.emit('play_audio_4');
            });
            // WebSocket event handler
            socket.on('play_audio', function () {
                // Play the audio file
                audio.play();
            });
            socket.on('play_audio_2', function () {
                // Play the audio file
                audio2.play();
            });
            socket.on('play_audio_3', function () {
                // Play the audio file
                audio3.play();
            });
            socket.on('play_audio_4', function () {
                // Play the audio file
                audio4.play();
            });
            socket.on('update_online_count', function (data) {
                document.getElementById('user-online').innerText = data.count;
            });

            // Add event listener for visibility change
            document.addEventListener("visibilitychange", handleVisibilityChange);

            socket.on('message', function (data) {
                var chatDiv = document.getElementById('chat-box');
                chatDiv.innerHTML += '<div class="message"><p class="user">' + data.message.sender + ':</p><p class="content">' + data.message.content + '</p></div>'
                if (document.visibilityState !== "visible") {
                    messageCount += 1
                    updateTabTitle(messageCount);
                }
            });

            // Function to handle form submission
            function handleSubmit(event) {
                event.preventDefault();

                // Get the input value from the form
                const inputElement = document.getElementById("chat-input");
                const inputErrorElement = document.getElementById("chat-input-error");
                const message = inputElement.value.trim();

                // Don't send an empty message
                if (!message) {
                    return;
                }

                const regexPattern = /ok.*(lets|let's) .*go/;
                // Check if the message at least contains ok lets go.
                if (regexPattern.test(message)) {
                    socket.emit('message', { message: message, user_id: userId });
                    inputElement.value = '';
                    inputErrorElement.innerHTML = '';
                } else {
                    inputErrorElement.innerHTML = '<p>Please at least use "ok lets go" in your message.</p>'
                }

            }
            // Attach the form submission event listener
            const chatForm = document.getElementById("chat-form");
            chatForm.addEventListener("submit", handleSubmit);

            function handleModalSubmit(event) {
                event.preventDefault();
                const inputData = modalInput.value;
                modal.style.display = 'none';
                socket.emit('set_name', { name: inputData });
            }

            const modalInput = document.getElementById('modal-input');
            modalInput.focus();
            const modal = document.getElementById('modal');
            const modalForm = document.getElementById("modal-form");
            modalForm.addEventListener("submit", handleModalSubmit);
            const modalButton = document.getElementById('modal-button');
            modalButton.addEventListener('click', handleModalSubmit);

            async function loadSubscription() {
                let subscribed = await checkSubscribed(userId);
                updateSubscriptionButton(subscribed)
                // Check if the browser supports service workers and push notifications
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    subscribeButton.addEventListener('click', async function () {
                        subscribed = await clickSubscriptionButton(subscribed);
                    });
                }
            }
            loadSubscription()
        });
    </script>
</body>

</html>